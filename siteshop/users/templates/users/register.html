{% extends "base.html" %}
{% load static %}

{% block "content" %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1 class="auth-title">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
            <p class="auth-subtitle">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</p>
        </div>

        <form method="post" class="auth-form" novalidate>
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.GET.next }}">
            
            {% if form.non_field_errors %}
            <div class="auth-error">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}

            {% for field in form %}
            <div class="input-field {% if field.field.widget.input_type == 'checkbox' %}input-field-checkbox{% endif %}">
                
                {% if field.field.widget.input_type == 'checkbox' %}
                    <label class="checkbox-label">
                        {{ field }}
                        <span class="checkbox-text">{{ field.label }}</span>
                    </label>
                {% else %}
                    <label for="{{ field.id_for_label }}" class="field-label">
                        {{ field.label }}
                        {% if field.field.required %}
                            <span class="required">*</span>
                        {% else %}
                            <span class="optional">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        {% endif %}
                    </label>
                    
                    {% if 'password' in field.name %}
                    <div class="password-field">
                        {{ field }}
                        <button type="button" class="password-toggle" onclick="togglePassword(this)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path class="icon" 
                                      data-show="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" 
                                      data-hide="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24 M1 1l22 22" 
                                      d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z">
                                </path>
                                <circle class="icon-dot" data-show="12 12 3" data-hide="" cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                    {% else %}
                        {{ field }}
                    {% endif %}
                {% endif %}

                {% if field.help_text %}
                <div class="field-help">
                    {{ field.help_text|safe }}
                </div>
                {% endif %}

                {% if field.errors %}
                <div class="field-error">
                    {% for error in field.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}


            <button type="submit" class="auth-button">
                –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
            </button>

            <div class="auth-links">
                <p>
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? 
                    <a href="{% url 'users:login' %}" class="link">–í–æ–π—Ç–∏</a>
                </p>
            </div>
        </form>
    </div>
</div>

<script>
function togglePassword(button) {
    const input = button.parentElement.querySelector('input');
    const path = button.querySelector('.icon');
    const circle = button.querySelector('.icon-dot');
    
    if (input.type === 'password') {
        input.type = 'text';
        path.setAttribute('d', path.getAttribute('data-hide'));
        circle.setAttribute('cx', '');
        circle.setAttribute('cy', '');
        circle.setAttribute('r', '');
    } else {
        input.type = 'password';
        const dataShow = path.getAttribute('data-show');
        if (dataShow.includes(' M')) {
            path.setAttribute('d', dataShow.split(' M')[0]);
            const coords = dataShow.split(' M')[2].split(' ');
            if (coords.length >= 3) {
                circle.setAttribute('cx', coords[0]);
                circle.setAttribute('cy', coords[1]);
                circle.setAttribute('r', coords[2]);
            }
        } else {
            path.setAttribute('d', dataShow);
        }
    }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
document.querySelector('.auth-form').addEventListener('submit', function(e) {
    let hasErrors = false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    document.querySelectorAll('.form-input[required]').forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('invalid');
            hasErrors = true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            let errorDiv = input.parentElement.querySelector('.field-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'field-error';
                input.parentElement.appendChild(errorDiv);
            }
            errorDiv.textContent = '–≠—Ç–æ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
        }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
    const password1 = document.querySelector('input[name="password1"]');
    const password2 = document.querySelector('input[name="password2"]');
    
    if (password1 && password2 && password1.value !== password2.value) {
        [password1, password2].forEach(input => {
            input.classList.add('invalid');
            let errorDiv = input.parentElement.querySelector('.field-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'field-error';
                input.parentElement.appendChild(errorDiv);
            }
            errorDiv.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        });
        hasErrors = true;
    }
    
    if (hasErrors) {
        e.preventDefault();
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
        const firstError = document.querySelector('.invalid');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
    }
});

// –†–µ–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
document.querySelectorAll('.form-input').forEach(input => {
    input.addEventListener('input', function() {
        this.classList.remove('invalid');
        
        // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
        const errorDiv = this.parentElement.querySelector('.field-error');
        if (errorDiv && !errorDiv.hasAttribute('data-original')) {
            errorDiv.remove();
        }
    });
});
</script>
{% endblock %}