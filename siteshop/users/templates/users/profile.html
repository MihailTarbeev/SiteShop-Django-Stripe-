{% extends "base.html" %}
{% load static %}
{% block "content" %}

<div class="profile-container">
  <h2 class="profile-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
  
  <div class="profile-card">
    <form action="" method="POST" enctype="multipart/form-data" class="profile-form">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ next }}">
      
      <div class="avatar-section">
        <div class="avatar-container">
          {% if user.photo %}
          <img src="{{ user.photo.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-image" />
          {% else %}
          <img src="{{ default_user_image }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-image" />
          {% endif %}
        </div>
        
        <div class="photo-upload-wrapper">
          <label for="id_photo" class="photo-upload-label">
            <span class="upload-icon">üñºÔ∏è</span> –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ
            {{ form.photo }}
          </label>
          <div class="form-error photo-error">
            {{ form.photo.errors }}
          </div>
        </div>
      </div>

      <!-- –ë–ª–æ–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞–Ω–≥–∞ -->
      {% if rank_progress %}
      <div class="rank-progress-card">
          <div class="rank-header">
              <div>
                  <div class="rank-badge">
                      {{ rank_progress.current_rank.name }}
                  </div>
                  <h3 class="rank-amount">
                      {{ rank_progress.total_spent|floatformat:2 }} ‚ÇΩ
                  </h3>
                  <p class="rank-subtitle">
                      –û–±—â–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫
                  </p>
              </div>
              
              <div class="rank-percent-circle">
                  {{ rank_progress.progress_percent|floatformat:0 }}%
              </div>
          </div>
          
          <div class="progress-container">
              <div class="progress-track">
                  <div class="progress-fill" style="width: {{ rank_progress.progress_percent|floatformat:0 }}%;">
                      <div class="progress-marker"></div>
                  </div>
              </div>
              
              <div class="progress-labels">
                  <div style="display: flex; justify-content: space-between;">
                      <div class="progress-label-container">
                          <div class="progress-dot current"></div>
                          <span class="progress-value current">
                              {{ rank_progress.current_rank.min_total|floatformat:0 }} ‚ÇΩ
                          </span>
                      </div>
                      <div class="progress-label-container">
                          <div class="progress-dot {% if rank_progress.next_rank %}next{% else %}max{% endif %}"></div>
                          <span class="progress-value {% if rank_progress.next_rank %}next{% else %}max{% endif %}">
                              {% if rank_progress.next_rank %}
                                  {{ rank_progress.next_rank.min_total|floatformat:0 }} ‚ÇΩ
                              {% else %}
                                  MAX
                              {% endif %}
                          </span>
                      </div>
                  </div>
              </div>
          </div>
          
          <div class="stats-grid">
              <div class="stat-box stat-next">
                  <div class="stat-label">
                      {% if rank_progress.next_rank %}–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è{% else %}–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ{% endif %}
                  </div>
                  <div class="stat-value {% if not rank_progress.next_rank %}stat-max{% endif %}">
                      {% if rank_progress.next_rank %}
                          {{ rank_progress.needed|floatformat:2 }} ‚ÇΩ
                      {% else %}
                          üèÜ –ú–∞–∫—Å–∏–º—É–º
                      {% endif %}
                  </div>
              </div>
              
              {% if rank_progress.current_rank.discount %}
              <div class="discount-box">
                  <div class="discount-label">
                      –í–∞—à–∞ —Å–∫–∏–¥–∫–∞
                  </div>
                  <div class="discount-value">
                      {% if rank_progress.current_rank.discount.percent_off %}
                          {{ rank_progress.current_rank.discount.percent_off }}%
                      {% else %}
                          {{ rank_progress.current_rank.discount.amount_off }} ‚ÇΩ
                      {% endif %}
                  </div>
              </div>
              {% endif %}
          </div>
      </div>
      {% endif %}

      <!-- –û—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã -->
      {% if form.non_field_errors %}
      <div class="form-global-error">
          {{ form.non_field_errors }}
      </div>
      {% endif %}

      <!-- –ü–æ–ª—è —Ñ–æ—Ä–º—ã -->
      <div class="form-fields-grid">
          {% for field in form %}
              {% if field.name != 'photo' %}
              <div class="form-group {% if field.name == 'username' or field.name == 'email' %}disabled-field{% endif %}">
                  <label for="{{ field.id_for_label }}" class="form-label">
                      {{ field.label }}
                      {% if field.field.required %}
                          <span class="required-star">*</span>
                      {% endif %}
                      
                      {% if field.field.disabled %}
                          <span class="disabled-icon" title="–≠—Ç–æ –ø–æ–ª–µ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å">üîí</span>
                      {% endif %}
                  </label>

                            {% if field.name == 'email' %}
                <div class="disabled-input-wrapper">
                    <input type="email" name="{{ field.name }}" 
                        id="{{ field.id_for_label }}" 
                        value="{{ field.value|default_if_none:'' }}"
                        class="form-input email-input {% if field.field.disabled %}disabled-input{% endif %}"
                        {% if field.field.disabled %}disabled{% endif %}>
                    {% if field.field.disabled %}
                        <div class="disabled-hint">
                            <small>Email –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</small>
                        </div>
                    {% endif %}
                </div>
            {% elif field.name == 'username' %}
                <div class="disabled-input-wrapper">
                    <input type="text" name="{{ field.name }}" 
                        id="{{ field.id_for_label }}" 
                        value="{{ field.value|default_if_none:'' }}"
                        class="form-input text-input {% if field.field.disabled %}disabled-input{% endif %}"
                        {% if field.field.disabled %}disabled{% endif %}>
                    {% if field.field.disabled %}
                        <div class="disabled-hint">
                            <small>–õ–æ–≥–∏–Ω –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</small>
                        </div>
                    {% endif %}
                </div>
            {% elif field.field.widget.input_type == 'text' %}
                <input type="text" name="{{ field.name }}" 
                    id="{{ field.id_for_label }}" 
                    value="{{ field.value|default_if_none:'' }}"
                    class="form-input text-input {% if field.field.disabled %}disabled-input{% endif %}"
                    {% if field.field.disabled %}disabled{% endif %}>
            {% elif field.field.widget.input_type == 'textarea' %}
                <textarea name="{{ field.name }}" 
                        id="{{ field.id_for_label }}" 
                        class="form-textarea {% if field.field.disabled %}disabled-input{% endif %}"
                        {% if field.field.disabled %}disabled{% endif %}>{{ field.value|default_if_none:'' }}</textarea>
            {% elif field.field.widget.input_type == 'select' %}
                <select name="{{ field.name }}" 
                        id="{{ field.id_for_label }}"
                        class="form-select {% if field.field.disabled %}disabled-input{% endif %}"
                        {% if field.field.disabled %}disabled{% endif %}>
                    {% for choice in field.field.choices %}
                        <option value="{{ choice.0 }}" {% if field.value == choice.0 %}selected{% endif %}>
                            {{ choice.1 }}
                        </option>
                    {% endfor %}
                </select>
            {% else %}
                {{ field }}
            {% endif %}
                  
                  <div class="form-error field-error">
                      {{ field.errors }}
                  </div>
              </div>
              {% endif %}
          {% endfor %}
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
      <div class="form-submit-section">
          <button type="submit" class="submit-button">
            <span class="button-icon">üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          </button>
      </div>
    </form>

    <hr class="section-divider">
    
    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="action-buttons">
      <a href="{% url 'users:logout' %}" class="action-button logout-button" style="color: white">
        <span class="button-icon">üö™</span> –í—ã–π—Ç–∏
      </a>
    </div>
  </div>
</div>

<!-- –ë–ª–æ–∫ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<hr>
{% if items.count > 0 %}
  <h3><span>–í–∞—à–∏ —Ç–æ–≤–∞—Ä—ã</span></h3> 

  <div class="user-items-grid">
      {% for item in items %}
      
      <div class="user-item-card">
          
          {% if item.image %}
          <a href="{{ item.get_absolute_url }}" class="item-image-link">
              <img src="{{ item.image.url }}" alt="{{ item.name }}" class="item-image" />
          </a>
          {% else %}
          <a href="{{ item.get_absolute_url }}" class="item-image-link">
              <img src="{{ default_item_image }}" alt="{{ item.name }}" class="item-image" />
          </a>
          {% endif %}

          <div class="item-content">
              <h3 class="item-title">
                  <a href="{{ item.get_absolute_url }}">
                      {{ item.name }}
                  </a>
              </h3>
              
              <p class="item-description">
                  {{ item.description|truncatechars:45 }}
              </p>
          </div>

          <div class="item-footer">
              <p class="item-price">
                  {{ item.price }} {{ item.currency.symbol }}
              </p>
          </div>
      </div>
      {% endfor %}
  </div>

{% else %}
  <h3><span>–í—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä</span></h3>
{% endif %}

{% endblock %}