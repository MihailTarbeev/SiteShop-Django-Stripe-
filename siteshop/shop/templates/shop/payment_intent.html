{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    
    <link rel="stylesheet" href="{% static 'shop/css/payment_intent.css' %}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h1>
            <p>–ó–∞–∫–∞–∑ #{{ order_id }}</p>
        </div>

        <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        {% comment %} <div class="debug-info">
            <strong>–û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong>
            ‚Ä¢ –¢–æ–≤–∞—Ä–æ–≤: {{ items_count }} —à—Ç.<br>
            ‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Å—É–º–º–∞: {{ base_price_total|floatformat:2 }} {{ currency }}<br>
            {% if tax_amount_total %}
            ‚Ä¢ –ù–∞–ª–æ–≥–∏: +{{ tax_amount_total|floatformat:2 }} {{ currency }}<br>
            {% endif %}
            {% if discount_amount %}
            ‚Ä¢ –°–∫–∏–¥–∫–∞: -{{ discount_amount|floatformat:2 }} {{ currency }}<br>
            {% endif %}
            ‚Ä¢ <strong>–ò—Ç–æ–≥–æ: {{ total_amount|floatformat:2 }} {{ currency }}</strong><br>
            ‚Ä¢ Stripe Key: {{ stripe_public_key|slice:":20" }}...<br>
            ‚Ä¢ PaymentIntent: {{ payment_intent_id }}
        </div> {% endcomment %}


        <div class="order-card">
            <div class="card-section">
                <div class="section-title">üì¶ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</div>
                
                {% for item in items %}
                <div class="order-item">
                    <div class="item-image">
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.name }}">
                        {% else %}
                        <img src="{{ default_image }}" alt="–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                        {% endif %}
                    </div>
                    
                    <div class="item-details">
                        <div class="item-name">{{ item.name }}</div>
                        
                        <div class="item-meta">
                            <div class="item-quantity">
                                –ö–æ–ª-–≤–æ {{ item.quantity }}<br>
                                <small>{{ item.price|floatformat:2 }} {{ currency }} —à—Ç.</small>
                            </div>
                            <div class="item-total">{{ item.total|floatformat:2 }} {{ currency }}</div>
                        </div>
                        
                        {% if item.taxes %}
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            {% for tax in item.taxes %}
                            <span>{{ tax.display_name }} ({{ tax.percentage }}%)</span>
                            {% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="card-section">
                <div class="section-title">üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</div>
                
                <div class="summary-grid">
                    <div class="summary-row">
                        <span class="summary-label">–ü–æ–¥—ã—Ç–æ–≥ ({{ items_count }} —à—Ç.)</span>
                        <span class="summary-value">{{ base_price_total|floatformat:2 }} {{ currency }}</span>
                    </div>
                    
                    {% if tax_amount_total %}
                    <div class="summary-row tax-row">
                        <span class="summary-label">–ù–∞–ª–æ–≥–∏</span>
                        <span class="summary-value">+{{ tax_amount_total|floatformat:2 }} {{ currency }}</span>
                    </div>
                    {% endif %}
                    
                    {% if discount_amount %}
                    <div class="summary-row discount-row">
                        <span class="summary-label">
                            {% if rank_name %}
                            –ö—É–ø–æ–Ω –¥–ª—è {{ rank_name }}
                            {% else %}
                            –°–∫–∏–¥–∫–∞
                            {% endif %}
                            {% if discount_percent %}
                            ({{ discount_percent }}%)
                            {% endif %}
                        </span>
                        <span class="summary-value">-{{ discount_amount|floatformat:2 }} {{ currency }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="summary-row" style="border-top: 2px solid #ddd; margin-top: 10px; padding-top: 15px;">
                        <span class="summary-label" style="font-size: 18px; font-weight: 600;">–í—Å–µ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</span>
                        <span class="summary-total">{{ total_amount|floatformat:2 }} {{ currency }}</span>
                    </div>
                </div>
            </div>

            <div class="card-section">
                <div class="section-title">üí≥ –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã</div>
                
                <div class="payment-form">
                    <div id="card-element">
                        <div id="loading">
                            <div class="spinner"></div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã...</p>
                        </div>
                    </div>
                    
                    <div id="card-errors"></div>
                    
                    <button id="submit-button" class="pay-button" disabled>
                        –û–ø–ª–∞—Ç–∏—Ç—å {{ total_amount|floatformat:2 }} {{ currency }}
                    </button>
                </div>
            </div>

            <div class="card-section">
                <details class="test-cards">
                    <summary>–¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</summary>
                    <ul>
                        <li><code>4242 4242 4242 4242</code> - —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂</li>
                        <li><code>4000 0000 0000 9995</code> - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤</li>
                        <li><code>4000 0027 6000 3184</code> - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</li>
                    </ul>
                </details>
            </div>
        </div>

        <div class="actions">
            <a href="{% url 'view_cart' %}" class="btn btn-secondary">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É</a>
            <a href="{% url 'home' %}" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    
    <script>

    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–õ–ê–¢–ï–ñ–ê ===');
        
        function waitForStripe() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 30;
                
                function check() {
                    attempts++;
                    if (typeof Stripe !== 'undefined') {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Stripe.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è'));
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }
        
        async function initializePayment() {
            try {
                console.log('1. –ü—Ä–æ–≤–µ—Ä—è–µ–º Stripe.js...');
                await waitForStripe();
                console.log('‚úÖ Stripe.js –∑–∞–≥—Ä—É–∂–µ–Ω');
                
                const publicKey = '{{ stripe_public_key }}';
                if (!publicKey || publicKey.includes('None')) {
                    throw new Error('–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á Stripe');
                }
                
                console.log('2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Stripe...');
                const stripe = Stripe(publicKey);
                
                console.log('3. –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É...');
                const elements = stripe.elements();
                const cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#32325d',
                            fontFamily: '-apple-system, BlinkMacSystemFont, sans-serif',
                            '::placeholder': {
                                color: '#aab7c4'
                            }
                        }
                    }
                });
                

                document.getElementById('loading').style.display = 'none';
                cardElement.mount('#card-element');
                
                const submitButton = document.getElementById('submit-button');
                submitButton.disabled = false;
                
                cardElement.addEventListener('change', function(event) {
                    const errorDiv = document.getElementById('card-errors');
                    if (event.error) {
                        errorDiv.textContent = event.error.message;
                        errorDiv.style.display = 'block';
                    } else {
                        errorDiv.style.display = 'none';
                    }
                });
                

                submitButton.addEventListener('click', async function() {
                    const button = this;
                    const originalText = button.textContent;
                    
                    button.disabled = true;
                    button.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
                    

                    document.getElementById('card-errors').style.display = 'none';
                    
                    try {
                        console.log('–ù–∞—á–∏–Ω–∞–µ–º –æ–ø–ª–∞—Ç—É...');
                        
                        const result = await stripe.confirmCardPayment('{{ client_secret }}', {
                            payment_method: {
                                card: cardElement,
                                billing_details: {
                                    name: '{{ user.get_full_name|default:user.username }}'
                                }
                            }
                        });
                        
                        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                        
                        if (result.error) {
                            const errorDiv = document.getElementById('card-errors');
                            errorDiv.textContent = '‚ùå ' + result.error.message;
                            errorDiv.style.display = 'block';
                            button.disabled = false;
                            button.textContent = originalText;
                        } else {
                            button.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ!';
                            setTimeout(() => {
                                window.location.href = "{% url 'payment_intent_success' %}?payment_intent={{ payment_intent_id }}";
                            }, 1500);
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        const errorDiv = document.getElementById('card-errors');
                        errorDiv.textContent = '‚ùå ' + error.message;
                        errorDiv.style.display = 'block';
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                });
                
                
            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #dc3545; text-align: center;">' +
                    '<p><strong>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã</strong></p>' +
                    '<p>' + error.message + '</p>' +
                    '<p><small>–û—Ç–∫–ª—é—á–∏—Ç–µ AdBlock –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</small></p>' +
                    '</div>';
            }
        }
        

        initializePayment();
    });
    </script>
</body>
</html>